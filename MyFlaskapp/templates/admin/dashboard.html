{% extends "admin/base.html" %}

{% block admin_content %}
<h2 class="mb-4 text-warning">Hokage Panel (Admin)</h2>

<div class="card bg-dark text-white border-secondary">
    <div class="card-header bg-dark border-bottom border-secondary d-flex justify-content-between align-items-center">
        <span>Village Census (Users)</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.firstname }} {{ user.lastname }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ user.role }}</td>
                        <td>
                            {% if user.role != 'Admin' %}
                            <form method="post" action="{{ url_for('admin.toggle_status', user_id=user.id) }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-warning">Toggle Status</button>
                            </form>
                            <button type="button" class="btn btn-sm btn-outline-primary manage-games-btn" data-user-id="{{ user.id }}">Manage Games</button>
                            <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}" class="d-inline" onsubmit="return confirm('Exile this ninja?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="manageGamesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Manage Games</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="gamesList" class="list-group"></div>
        <div id="gamesFeedback" class="mt-3"></div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-warning" id="saveGameAccessBtn">Apply Changes</button>
      </div>
    </div>
  </div>
</div>
<script>
let selectedUserId = null;
const modalEl = document.getElementById('manageGamesModal');
const gamesListEl = document.getElementById('gamesList');
const feedbackEl = document.getElementById('gamesFeedback');
const saveBtn = document.getElementById('saveGameAccessBtn');
document.querySelectorAll('.manage-games-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    selectedUserId = btn.getAttribute('data-user-id');
    feedbackEl.innerHTML = '';
    gamesListEl.innerHTML = '';
    try {
      const r = await fetch(`/admin/user/${selectedUserId}/game-access`);
      if (!r.ok) throw new Error('Failed');
      const data = await r.json();
      data.games.forEach(g => {
        const item = document.createElement('div');
        item.className = 'list-group-item bg-dark text-white d-flex justify-content-between align-items-center';
        const label = document.createElement('span');
        label.textContent = g.name;
        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className = 'form-check-input ms-2';
        toggle.checked = !!g.is_allowed;
        toggle.dataset.gameId = g.id;
        item.appendChild(label);
        item.appendChild(toggle);
        gamesListEl.appendChild(item);
      });
      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    } catch (_) {
      feedbackEl.innerHTML = '<div class="alert alert-danger">Unable to load games.</div>';
    }
  });
});
saveBtn.addEventListener('click', async () => {
  if (!selectedUserId) return;
  feedbackEl.innerHTML = '';
  const updates = Array.from(gamesListEl.querySelectorAll('input[type="checkbox"]')).map(cb => ({
    game_id: parseInt(cb.dataset.gameId),
    is_allowed: cb.checked
  }));
  try {
    const r = await fetch(`/admin/user/${selectedUserId}/game-access`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': (document.querySelector('meta[name="csrf-token"]')||{}).content || '' },
      body: JSON.stringify({ updates })
    });
    if (!r.ok) throw new Error('Failed');
    const data = await r.json();
    feedbackEl.innerHTML = `<div class="alert alert-success">Updated ${data.updated} item(s).</div>`;
  } catch (_) {
    feedbackEl.innerHTML = '<div class="alert alert-danger">Update failed.</div>';
  }
});
</script>
{% endblock %}
