{% extends "admin/base.html" %}

{% block admin_content %}
<h2 class="mb-4 text-warning">Leaderboard Management</h2>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-body">
                <h5 class="card-title text-info">Total Users</h5>
                <h3 class="text-light">{{ stats.total_users }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-body">
                <h5 class="card-title text-info">Total Games</h5>
                <h3 class="text-light">{{ stats.total_games }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-body">
                <h5 class="card-title text-info">Total Scores</h5>
                <h3 class="text-light">{{ stats.total_scores }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-body">
                <h5 class="card-title text-info">Valid Scores</h5>
                <h3 class="text-light">{{ stats.valid_scores }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard Scores Table -->
<div class="card bg-dark text-white border-secondary mb-4">
    <div class="card-header bg-dark border-bottom border-secondary d-flex justify-content-between align-items-center">
        <span>Recent Leaderboard Scores</span>
        <div>
            <select id="gameFilter" class="form-select form-select-sm d-inline-block w-auto me-2">
                <option value="">All Games</option>
                {% for game in games %}
                <option value="{{ game.id }}">{{ game.name }}</option>
                {% endfor %}
            </select>
            <select id="validityFilter" class="form-select form-select-sm d-inline-block w-auto">
                <option value="">All Scores</option>
                <option value="1">Valid Only</option>
                <option value="0">Invalid Only</option>
            </select>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0" id="scoresTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Game</th>
                        <th>Score</th>
                        <th>Rank</th>
                        <th>Difficulty</th>
                        <th>Playtime</th>
                        <th>Valid</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for score in scores %}
                    <tr>
                        <td>{{ score.id }}</td>
                        <td>{{ score.firstname }} {{ score.lastname }}</td>
                        <td>{{ score.game_name }}</td>
                        <td class="text-warning fw-bold">{{ score.score_value|round(2) }}</td>
                        <td><span class="badge bg-info">{{ score.rank_position or '-' }}</span></td>
                        <td><span class="badge bg-secondary">{{ score.difficulty_level }}</span></td>
                        <td>{{ score.playtime_seconds }}s</td>
                        <td>
                            {% if score.is_valid %}
                            <span class="badge bg-success">Valid</span>
                            {% else %}
                            <span class="badge bg-danger">Invalid</span>
                            {% endif %}
                        </td>
                        <td>{{ score.achieved_at.strftime('%Y-%m-%d %H:%M') if score.achieved_at else '-' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info view-metrics" data-score-id="{{ score.id }}">Metrics</button>
                            {% if score.is_valid %}
                            <button class="btn btn-sm btn-outline-warning invalidate-score" data-score-id="{{ score.id }}">Invalidate</button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-success validate-score" data-score-id="{{ score.id }}">Validate</button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-danger delete-score" data-score-id="{{ score.id }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Score Validation Rules -->
<div class="card bg-dark text-white border-secondary mb-4">
    <div class="card-header bg-dark border-bottom border-secondary d-flex justify-content-between align-items-center">
        <span>Score Validation Rules</span>
        <div>
            <button class="btn btn-sm btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#testRuleModal">Test Rules</button>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">Add Rule</button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Max Score</th>
                        <th>Min Score</th>
                        <th>Max Playtime</th>
                        <th>Multiplier</th>
                        <th>Advanced Rules</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in validation_rules %}
                    <tr>
                        <td>{{ rule.game_name or 'All Games' }}</td>
                        <td>{{ rule.max_score or 'Unlimited' }}</td>
                        <td>{{ rule.min_score or 0 }}</td>
                        <td>{{ rule.max_playtime_seconds or 'Unlimited' }}s</td>
                        <td>{{ rule.score_multiplier }}</td>
                        <td>
                            {% if rule.validation_rules %}
                                <button class="btn btn-sm btn-outline-info view-advanced-rules" data-rule-id="{{ rule.id }}" data-rules="{{ rule.validation_rules|e }}">
                                    <i class="fas fa-eye"></i> Rules
                                </button>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rule.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary edit-rule" data-rule-id="{{ rule.id }}">Edit</button>
                            <button class="btn btn-sm btn-outline-warning toggle-rule" data-rule-id="{{ rule.id }}">
                                {% if rule.is_active %}Deactivate{% else %}Activate{% endif %}
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-rule" data-rule-id="{{ rule.id }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Rankings Overview -->
<div class="card bg-dark text-white border-secondary">
    <div class="card-header bg-dark border-bottom border-secondary">
        <span>Current Rankings</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>#1 Player</th>
                        <th>#1 Score</th>
                        <th>#2 Player</th>
                        <th>#2 Score</th>
                        <th>#3 Player</th>
                        <th>#3 Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ranking in rankings %}
                    <tr>
                        <td>{{ ranking.game_name }}</td>
                        <td>{{ ranking.first_player }}</td>
                        <td class="text-warning">{{ ranking.first_score|round(2) }}</td>
                        <td>{{ ranking.second_player }}</td>
                        <td class="text-warning">{{ ranking.second_score|round(2) }}</td>
                        <td>{{ ranking.third_player }}</td>
                        <td class="text-warning">{{ ranking.third_score|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Metrics Modal -->
<div class="modal fade" id="metricsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Score Metrics</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="metricsContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Add Validation Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Game</label>
                                <select name="game_id" class="form-select">
                                    <option value="">All Games</option>
                                    {% for game in games %}
                                    <option value="{{ game.id }}">{{ game.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Score</label>
                                <input type="number" name="max_score" class="form-control" step="0.01" placeholder="Unlimited if empty">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Min Score</label>
                                <input type="number" name="min_score" class="form-control" step="0.01" value="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Playtime (seconds)</label>
                                <input type="number" name="max_playtime_seconds" class="form-control" placeholder="Unlimited if empty">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Score Multiplier</label>
                                <input type="number" name="score_multiplier" class="form-control" step="0.01" value="1.0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">Advanced Validation Rules</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Score per Minute</label>
                                <input type="number" name="max_score_per_minute" class="form-control" step="0.01" placeholder="e.g., 1000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Impossible Threshold</label>
                                <input type="number" name="impossible_threshold" class="form-control" step="0.01" placeholder="e.g., 999999">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="require_session_validation" id="requireSessionValidation">
                                    <label class="form-check-label" for="requireSessionValidation">
                                        Require Session Validation
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Min Accuracy (0.0-1.0)</label>
                                <input type="number" name="min_accuracy" class="form-control" step="0.01" min="0" max="1" placeholder="e.g., 0.1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Combo Multiplier</label>
                                <input type="number" name="max_combo_multiplier" class="form-control" step="0.01" placeholder="e.g., 5">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- View Advanced Rules Modal -->
<div class="modal fade" id="viewRulesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Advanced Validation Rules</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="advancedRulesContent" class="text-light bg-secondary p-3 rounded"></pre>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Edit Validation Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" name="rule_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Game</label>
                                <select name="game_id" class="form-select">
                                    <option value="">All Games</option>
                                    {% for game in games %}
                                    <option value="{{ game.id }}">{{ game.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Score</label>
                                <input type="number" name="max_score" class="form-control" step="0.01" placeholder="Unlimited if empty">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Min Score</label>
                                <input type="number" name="min_score" class="form-control" step="0.01" value="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Playtime (seconds)</label>
                                <input type="number" name="max_playtime_seconds" class="form-control" placeholder="Unlimited if empty">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Score Multiplier</label>
                                <input type="number" name="score_multiplier" class="form-control" step="0.01" value="1.0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">Advanced Validation Rules</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Score per Minute</label>
                                <input type="number" name="max_score_per_minute" class="form-control" step="0.01" placeholder="e.g., 1000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Impossible Threshold</label>
                                <input type="number" name="impossible_threshold" class="form-control" step="0.01" placeholder="e.g., 999999">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="require_session_validation" id="editRequireSessionValidation">
                                    <label class="form-check-label" for="editRequireSessionValidation">
                                        Require Session Validation
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Min Accuracy (0.0-1.0)</label>
                                <input type="number" name="min_accuracy" class="form-control" step="0.01" min="0" max="1" placeholder="e.g., 0.1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Combo Multiplier</label>
                                <input type="number" name="max_combo_multiplier" class="form-control" step="0.01" placeholder="e.g., 5">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateRuleBtn">Update Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Rule Modal -->
<div class="modal fade" id="testRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Test Validation Rules</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRuleForm">
                    <div class="mb-3">
                        <label class="form-label">Game</label>
                        <select name="game_id" class="form-select" required>
                            <option value="">Select a game</option>
                            {% for game in games %}
                            <option value="{{ game.id }}">{{ game.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Score Value</label>
                        <input type="number" name="score_value" class="form-control" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Playtime (seconds)</label>
                        <input type="number" name="playtime_seconds" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Difficulty Level</label>
                        <select name="difficulty_level" class="form-select">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </form>
                <div id="testResult" class="mt-3"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" id="testRuleBtn">Test Rule</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const gameFilter = document.getElementById('gameFilter');
    const validityFilter = document.getElementById('validityFilter');
    const scoresTable = document.getElementById('scoresTable');
    
    function filterTable() {
        const gameId = gameFilter.value;
        const validity = validityFilter.value;
        
        Array.from(scoresTable.querySelectorAll('tbody tr')).forEach(row => {
            const rowGameId = row.querySelector('td:nth-child(3)').textContent;
            const rowValidity = row.querySelector('td:nth-child(8) .badge').classList.contains('bg-success');
            
            const gameMatch = !gameId || rowGameId.includes(gameId);
            const validityMatch = !validity || (validity === '1' && rowValidity) || (validity === '0' && !rowValidity);
            
            row.style.display = gameMatch && validityMatch ? '' : 'none';
        });
    }
    
    gameFilter.addEventListener('change', filterTable);
    validityFilter.addEventListener('change', filterTable);
    
    // View metrics
    document.querySelectorAll('.view-metrics').forEach(btn => {
        btn.addEventListener('click', async function() {
            const scoreId = this.dataset.scoreId;
            try {
                const response = await fetch(`/admin/leaderboard/score/${scoreId}/metrics`);
                const data = await response.json();
                
                const metricsContent = document.getElementById('metricsContent');
                metricsContent.innerHTML = `
                    <h6>Additional Metrics</h6>
                    <pre class="text-light">${JSON.stringify(data.metrics, null, 2)}</pre>
                    <div class="mt-3">
                        <strong>Session ID:</strong> ${data.session_id || 'N/A'}<br>
                        <strong>Validation Hash:</strong> ${data.validation_hash || 'N/A'}<br>
                        <strong>Created:</strong> ${data.created_at || 'N/A'}<br>
                        <strong>Updated:</strong> ${data.updated_at || 'N/A'}
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('metricsModal')).show();
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        });
    });
    
    // Validate/Invalidate scores
    document.querySelectorAll('.validate-score, .invalidate-score').forEach(btn => {
        btn.addEventListener('click', async function() {
            const scoreId = this.dataset.scoreId;
            const action = this.classList.contains('validate-score') ? 'validate' : 'invalidate';
            
            if (confirm(`Are you sure you want to ${action} this score?`)) {
                try {
                    const response = await fetch(`/admin/leaderboard/score/${scoreId}/${action}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Operation failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Operation failed');
                }
            }
        });
    });
    
    // Delete scores
    document.querySelectorAll('.delete-score').forEach(btn => {
        btn.addEventListener('click', async function() {
            const scoreId = this.dataset.scoreId;
            
            if (confirm('Are you sure you want to delete this score? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/admin/leaderboard/score/${scoreId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Delete failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Delete failed');
                }
            }
        });
    });
    
    // Toggle validation rules
    document.querySelectorAll('.toggle-rule').forEach(btn => {
        btn.addEventListener('click', async function() {
            const ruleId = this.dataset.ruleId;
            
            try {
                const response = await fetch(`/admin/leaderboard/rules/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    }
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Toggle failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Toggle failed');
            }
        });
    });
    
    // Delete validation rules
    document.querySelectorAll('.delete-rule').forEach(btn => {
        btn.addEventListener('click', async function() {
            const ruleId = this.dataset.ruleId;
            
            if (confirm('Are you sure you want to delete this validation rule?')) {
                try {
                    const response = await fetch(`/admin/leaderboard/rules/${ruleId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Delete failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Delete failed');
                }
            }
        });
    });
    
    // Add validation rule
    document.getElementById('saveRuleBtn').addEventListener('click', async function() {
        const form = document.getElementById('addRuleForm');
        const formData = new FormData(form);
        
        // Build advanced validation rules object
        const advancedRules = {};
        if (formData.get('max_score_per_minute')) {
            advancedRules.max_score_per_minute = parseFloat(formData.get('max_score_per_minute'));
        }
        if (formData.get('impossible_threshold')) {
            advancedRules.impossible_threshold = parseFloat(formData.get('impossible_threshold'));
        }
        if (formData.get('require_session_validation')) {
            advancedRules.require_session_validation = true;
        }
        if (formData.get('min_accuracy')) {
            advancedRules.custom_checks = { min_accuracy: parseFloat(formData.get('min_accuracy')) };
        }
        if (formData.get('max_combo_multiplier')) {
            if (!advancedRules.custom_checks) advancedRules.custom_checks = {};
            advancedRules.custom_checks.max_combo_multiplier = parseFloat(formData.get('max_combo_multiplier'));
        }

        const ruleData = {
            game_id: formData.get('game_id') || null,
            max_score: formData.get('max_score') ? parseFloat(formData.get('max_score')) : null,
            min_score: formData.get('min_score') ? parseFloat(formData.get('min_score')) : 0,
            max_playtime_seconds: formData.get('max_playtime_seconds') ? parseInt(formData.get('max_playtime_seconds')) : null,
            score_multiplier: formData.get('score_multiplier') ? parseFloat(formData.get('score_multiplier')) : 1.0,
            validation_rules: Object.keys(advancedRules).length > 0 ? JSON.stringify(advancedRules) : '{}'
        };
        
        try {
            const response = await fetch('/admin/leaderboard/rules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify(ruleData)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
                location.reload();
            } else {
                alert('Failed to add rule');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add rule');
        }
    });
    
    // View advanced rules
    document.querySelectorAll('.view-advanced-rules').forEach(btn => {
        btn.addEventListener('click', function() {
            const rules = this.dataset.rules;
            document.getElementById('advancedRulesContent').textContent = JSON.stringify(JSON.parse(rules), null, 2);
            new bootstrap.Modal(document.getElementById('viewRulesModal')).show();
        });
    });
    
    // Edit validation rule
    document.querySelectorAll('.edit-rule').forEach(btn => {
        btn.addEventListener('click', async function() {
            const ruleId = this.dataset.ruleId;
            
            try {
                const response = await fetch(`/admin/leaderboard/rules/${ruleId}`);
                const rule = await response.json();
                
                if (rule) {
                    // Populate edit form
                    const form = document.getElementById('editRuleForm');
                    form.querySelector('[name="rule_id"]').value = rule.id;
                    form.querySelector('[name="game_id"]').value = rule.game_id || '';
                    form.querySelector('[name="max_score"]').value = rule.max_score || '';
                    form.querySelector('[name="min_score"]').value = rule.min_score || 0;
                    form.querySelector('[name="max_playtime_seconds"]').value = rule.max_playtime_seconds || '';
                    form.querySelector('[name="score_multiplier"]').value = rule.score_multiplier || 1.0;
                    
                    // Parse and populate advanced rules
                    if (rule.validation_rules) {
                        const advanced = JSON.parse(rule.validation_rules);
                        form.querySelector('[name="max_score_per_minute"]').value = advanced.max_score_per_minute || '';
                        form.querySelector('[name="impossible_threshold"]').value = advanced.impossible_threshold || '';
                        form.querySelector('#editRequireSessionValidation').checked = advanced.require_session_validation || false;
                        form.querySelector('[name="min_accuracy"]').value = advanced.custom_checks?.min_accuracy || '';
                        form.querySelector('[name="max_combo_multiplier"]').value = advanced.custom_checks?.max_combo_multiplier || '';
                    }
                    
                    new bootstrap.Modal(document.getElementById('editRuleModal')).show();
                }
            } catch (error) {
                console.error('Error loading rule:', error);
                alert('Failed to load rule for editing');
            }
        });
    });
    
    // Update validation rule
    document.getElementById('updateRuleBtn').addEventListener('click', async function() {
        const form = document.getElementById('editRuleForm');
        const formData = new FormData(form);
        
        // Build advanced validation rules object
        const advancedRules = {};
        if (formData.get('max_score_per_minute')) {
            advancedRules.max_score_per_minute = parseFloat(formData.get('max_score_per_minute'));
        }
        if (formData.get('impossible_threshold')) {
            advancedRules.impossible_threshold = parseFloat(formData.get('impossible_threshold'));
        }
        if (formData.get('require_session_validation')) {
            advancedRules.require_session_validation = true;
        }
        if (formData.get('min_accuracy')) {
            advancedRules.custom_checks = { min_accuracy: parseFloat(formData.get('min_accuracy')) };
        }
        if (formData.get('max_combo_multiplier')) {
            if (!advancedRules.custom_checks) advancedRules.custom_checks = {};
            advancedRules.custom_checks.max_combo_multiplier = parseFloat(formData.get('max_combo_multiplier'));
        }
        
        const ruleData = {
            game_id: formData.get('game_id') || null,
            max_score: formData.get('max_score') ? parseFloat(formData.get('max_score')) : null,
            min_score: formData.get('min_score') ? parseFloat(formData.get('min_score')) : 0,
            max_playtime_seconds: formData.get('max_playtime_seconds') ? parseInt(formData.get('max_playtime_seconds')) : null,
            score_multiplier: formData.get('score_multiplier') ? parseFloat(formData.get('score_multiplier')) : 1.0,
            validation_rules: Object.keys(advancedRules).length > 0 ? JSON.stringify(advancedRules) : '{}'
        };
        
        try {
            const response = await fetch(`/admin/leaderboard/rules/${formData.get('rule_id')}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify(ruleData)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editRuleModal')).hide();
                location.reload();
            } else {
                alert('Failed to update rule');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update rule');
        }
    });
    
    // Test validation rules
    document.getElementById('testRuleBtn').addEventListener('click', async function() {
        const form = document.getElementById('testRuleForm');
        const formData = new FormData(form);
        
        const testData = {
            game_id: parseInt(formData.get('game_id')),
            score_value: parseFloat(formData.get('score_value')),
            playtime_seconds: parseInt(formData.get('playtime_seconds')),
            difficulty_level: formData.get('difficulty_level')
        };
        
        try {
            const response = await fetch('/admin/leaderboard/rules/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify(testData)
            });
            
            const result = await response.json();
            const resultDiv = document.getElementById('testResult');
            
            if (result.valid) {
                resultDiv.innerHTML = `<div class="alert alert-success">Score is VALID: ${result.message}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Score is INVALID: ${result.message}</div>`;
            }
            
            if (result.applied_rules) {
                resultDiv.innerHTML += `<div class="mt-2"><small>Applied rules: ${result.applied_rules.join(', ')}</small></div>`;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('testResult').innerHTML = '<div class="alert alert-danger">Test failed</div>';
        }
    });
});
</script>
{% endblock %}
