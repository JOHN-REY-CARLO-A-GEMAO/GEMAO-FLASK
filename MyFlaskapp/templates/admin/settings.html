{% extends "admin/base.html" %}

{% block admin_content %}
<h3 class="text-warning mb-3">Settings</h3>
  <div class="card bg-dark border-secondary mb-3">
    <div class="card-body">
      <h5 class="mb-3"><i class="bi bi-soundwave me-1"></i>Global Audio</h5>
      <div class="mb-3">
        <label class="form-label" for="masterVolume" data-bs-toggle="tooltip" title="Overall app volume; affects all sounds."><i class="bi bi-volume-up me-1"></i>Master Volume</label>
        {% set m = (audio_settings.get('master', 0.6) if audio_settings else 0.6) %}
        <input type="range" id="masterVolume" min="0" max="100" value="{{ (m * 100)|int }}" class="form-range" aria-label="Master volume">
      </div>
      <div class="mb-4">
        <label class="form-label" for="ambientVolume" data-bs-toggle="tooltip" title="Background music volume for non-interactive areas."><i class="bi bi-music-note-beamed me-1"></i>Ambient Music</label>
        {% set av = (audio_settings.get('ambient', 0.5) if audio_settings else 0.5) %}
        <input type="range" id="ambientVolume" min="0" max="100" value="{{ (av * 100)|int }}" class="form-range" aria-label="Ambient music volume">
      </div>

      <h5 class="mb-2"><i class="bi bi-controller me-1"></i>Game Audio Levels</h5>
      <p class="small text-secondary mb-3">Adjust sound for individual games. Hover labels for help.</p>
      <div class="list-group">
        {% for g in games %}
        {% set gv = (audio_settings.get('games', {}).get(g.name, 0.8) if audio_settings else 0.8) %}
        <div class="list-group-item bg-dark text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold" data-bs-toggle="tooltip" title="Audio level for this game.">{{ (g.name|replace('_',' ')|title) }}</div>
            <div class="w-50">
              <input type="range" class="form-range game-volume" data-game="{{ g.name }}" min="0" max="100" value="{{ (gv * 100)|int }}" aria-label="{{ (g.name|replace('_',' ')|title) }} volume">
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <button id="saveAudio" class="btn btn-warning" aria-label="Save audio settings"><i class="bi bi-save me-1"></i>Save</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const ms = document.getElementById('masterVolume');
      const am = document.getElementById('ambientVolume');
      if (ms) {
        ms.addEventListener('input', function(){
          const v = Math.max(0, Math.min(100, parseInt(this.value||'0',10)))/100;
          if (window.AudioManager) window.AudioManager.setMasterVolume(v);
        });
      }
      if (am) {
        am.addEventListener('input', function(){
          const v = Math.max(0, Math.min(100, parseInt(this.value||'0',10)))/100;
          if (window.AudioManager) window.AudioManager.setCategoryVolume('ambient', v);
        });
      }
      const btn = document.getElementById('saveAudio');
      if (btn) {
        btn.addEventListener('click', async function(){
          const master = Math.max(0, Math.min(100, parseInt((ms&&ms.value)||'0',10)))/100;
          const ambient = Math.max(0, Math.min(100, parseInt((am&&am.value)||'0',10)))/100;
          const perGame = {};
          document.querySelectorAll('.game-volume').forEach(el=>{
            const name = el.getAttribute('data-game');
            const v = Math.max(0, Math.min(100, parseInt(el.value||'0',10)))/100;
            if (name) perGame[name] = v;
          });
          try {
            const r = await fetch("{{ url_for('admin.settings_audio_update') }}", {
              method: 'POST',
              headers: {'Content-Type': 'application/json', 'X-CSRFToken': (document.querySelector('meta[name="csrf-token"]')||{}).content || ''},
              body: JSON.stringify({ master, ambient, per_game: perGame })
            });
            const j = await r.json();
            if (j && j.ok) {
              window.AudioManager && window.AudioManager.playNotification();
            }
          } catch(e) {}
        });
      }
    })();
  </script>
{% endblock %}
